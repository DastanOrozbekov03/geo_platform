{% load static %}
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF ‚Äî Generator</title>

<link rel="stylesheet" href="{% static 'css/generator.css' %}">
</head>

<body>

<header>
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
    <div class="theme-toggle" id="themeToggle">üåô</div>
</header>

<main class="container">

<h1>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏</h1>

<!-- –ü–∞–Ω–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏ -->
<div id="timePanel" class="time-panel">
    <svg class="icon" id="clockIcon" viewBox="0 0 24 24" fill="var(--icon-color)">
        <path d="M12 1a11 11 0 1 0 11 11A11.013 11.013 0 0 0 12 1Zm0 20a9 9 0 1 1 9-9a9.01 9.01 0 0 1-9 9Zm.5-14h-1v6l5.25 3.15l.5-.85L12.5 13Z"/>
    </svg>
    –ò—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: <span id="timeTotal">0</span> –º–∏–Ω –∏–∑ 45
</div>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ—à–µ–Ω–∏–π -->
<div class="solutions-toggle">
    <input type="checkbox" name="with_solutions" id="solutionsCheckbox" form="generatorForm">
    <label for="solutionsCheckbox">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏—è –≤ PDF</label>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters">
    <select id="filterLevel">
        <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
        <option value="1">–£—Ä–æ–≤–µ–Ω—å 1</option>
        <option value="2">–£—Ä–æ–≤–µ–Ω—å 2</option>
        <option value="3">–£—Ä–æ–≤–µ–Ω—å 3</option>
    </select>

    <select id="filterTopic">
        <option value="">–í—Å–µ —Ç–µ–º—ã</option>
        {% for topic in all_topics %}
            <option value="{{ topic }}">{{ topic }}</option>
        {% endfor %}
    </select>
</div>

<form id="generatorForm" action="/generator/pdf/" method="post">
{% csrf_token %}

<div id="taskContainer">
{% for task in tasks %}
<div class="task-item"
    data-level="{{ task.level }}"
    data-topic="{{ task.topic }}"
    data-time="{{ task.time_minutes }}"
    onclick="">
    
    <!-- –ß–µ–∫–±–æ–∫—Å -->
    <div style="margin-right:14px; margin-top:4px;">
        <input type="checkbox"
            name="selected_tasks"
            value="{{ task.id }}"
            class="task-checkbox">
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–¥–∞—á–∏ -->
    <div style="width:100%;">

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –≥–ª–∞–∑ -->
        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">

            <div>
                <strong>‚Ññ{{ task.id }} ‚Äî {{ task.topic }}</strong>
            </div>

            <!-- –ì–ª–∞–∑ —Å–ø—Ä–∞–≤–∞, –∫–ª–∏–∫ –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —á–µ–∫–±–æ–∫—Å -->
            <div class="preview-btn"
                style="cursor:pointer; font-size:20px; padding-left:12px;"
                data-id="{{ task.id }}"
                data-topic="{{ task.topic }}"
                data-level="{{ task.level }}"
                data-desc="{{ task.description }}"
                data-task="{{ task.task|escapejs }}"
                onclick="event.stopPropagation();">
                üëÅ
            </div>
        </div>

        <div class="task-meta">
            üîµ –£—Ä–æ–≤–µ–Ω—å: {{ task.level }} ‚Ä¢ ‚è± {{ task.time_minutes }} –º–∏–Ω
        </div>

        <div class="task-desc">
            {{ task.description }}
        </div>

    </div>
</div>
{% endfor %}
</div>

<button id="submitBtn" type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF</button>
</form>
<!-- ===== –ú–û–î–ê–õ ===== -->
<div class="modal-bg" id="modalBg">
    <div class="modal">
        <div class="modal-close" id="modalClose">‚úñ</div>
        <h2 id="modalTitle"></h2>

        <div class="modal-block"><strong>–¢–µ–º–∞:</strong> <span id="modalTopic"></span></div>
        <div class="modal-block"><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> <span id="modalLevel"></span></div>
        <div class="modal-block"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span id="modalDesc"></span></div>
        <div class="modal-block"><strong>–ó–∞–¥–∞—á–∞:</strong><br><pre id="modalTask" style="white-space: pre-wrap;"></pre></div>
    </div>
</div>
</main>

<script>
/* -------------------- –ü–µ—Ä–µ—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ -------------------- */
const checkboxes = document.querySelectorAll(".task-checkbox");
const timePanel = document.getElementById("timeTotal");
const timePanelBox = document.getElementById("timePanel");
const submitBtn = document.getElementById("submitBtn");
const MAX_TIME = 45;

function recalcTime(){
    let sum = 0;
    checkboxes.forEach(cb => {
        if(cb.checked){
            sum += parseInt(cb.closest(".task-item").dataset.time);
        }
    });

    timePanel.textContent = sum;

    if(sum > MAX_TIME){
        timePanelBox.classList.add("time-over");
        submitBtn.disabled = true;
    } else {
        timePanelBox.classList.remove("time-over");
        submitBtn.disabled = false;
    }
}

checkboxes.forEach(cb => cb.addEventListener("change", recalcTime));

/* -------------------- –§–∏–ª—å—Ç—Ä—ã -------------------- */
function applyFilters(){
    const level = document.getElementById("filterLevel").value;
    const topic = document.getElementById("filterTopic").value;

    document.querySelectorAll(".task-item").forEach(item => {
        const lvl = item.dataset.level;
        const tpc = item.dataset.topic;

        const matchLevel = !level || lvl === level;
        const matchTopic = !topic || tpc === topic;

        item.style.display = matchLevel && matchTopic ? "flex" : "none";
    });
}

document.getElementById("filterLevel").addEventListener("change", applyFilters);
document.getElementById("filterTopic").addEventListener("change", applyFilters);

/* -------------------- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ -------------------- */

const toggle = document.getElementById("themeToggle");

function updateIcon(){
    toggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
}

if(localStorage.getItem("theme") === "dark"){
    document.body.classList.add("dark");
}
updateIcon();

toggle.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    updateIcon();
});

/* -------------------- –ú–û–î–ê–õ -------------------- */

const modalBg = document.getElementById("modalBg");
const modalClose = document.getElementById("modalClose");

const mTitle = document.getElementById("modalTitle");
const mTopic = document.getElementById("modalTopic");
const mLevel = document.getElementById("modalLevel");
const mDesc = document.getElementById("modalDesc");
const mTask = document.getElementById("modalTask");

document.querySelectorAll(".preview-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        mTitle.textContent = "–ó–∞–¥–∞—á–∞ ‚Ññ" + btn.dataset.id;
        mTopic.textContent = btn.dataset.topic;
        mLevel.textContent = btn.dataset.level;
        mDesc.textContent = btn.dataset.desc;
        mTask.textContent = btn.dataset.task;

        modalBg.style.display = "flex";
    });
});

modalClose.addEventListener("click", () => {
    modalBg.style.display = "none";
});

modalBg.addEventListener("click", (e) => {
    if (e.target === modalBg) modalBg.style.display = "none";
});

</script>

</body>
</html>
