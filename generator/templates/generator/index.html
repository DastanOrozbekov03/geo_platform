{% load static %}
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF ‚Äî Generator</title>
<link rel="stylesheet" href="{% static 'css/generator.css' %}">
</head>

<body>

<header>
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
    <div class="theme-toggle" id="themeToggle">üåô</div>
</header>

<main class="container">

<h1>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏</h1>

<div id="timePanel" class="time-panel">
    –ò—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: <span id="timeTotal">0</span> –º–∏–Ω –∏–∑ {{ MAX_TIME|default:45 }}
</div>

<form id="generatorForm" action="{% url 'generator:generate_pdf' %}" method="post">
{% csrf_token %}

<div id="taskContainer">
{% for task in tasks %}
<div class="task-item" data-level="{{ task.level }}" data-topic="{{ task.topic }}" data-time="{{ task.time_minutes }}">
    <div style="margin-right:14px; margin-top:4px;">
        <input type="checkbox" name="selected_tasks" value="{{ task.id }}" class="task-checkbox">
    </div>

    <div style="width:100%;">
        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
            <div><strong>‚Ññ{{ task.id }} ‚Äî {{ task.topic }}</strong></div>

            <div class="preview-btn"
                style="cursor:pointer; font-size:20px; padding-left:12px;"
                data-id="{{ task.id }}"
                data-topic="{{ task.topic }}"
                data-level="{{ task.level }}"
                data-desc="{{ task.description }}"
                data-task="{{ task.task|escapejs }}">
                üëÅ
            </div>
        </div>

        <div class="task-meta">üîµ –£—Ä–æ–≤–µ–Ω—å: {{ task.level }} ‚Ä¢ ‚è± {{ task.time_minutes }} –º–∏–Ω</div>
        <div class="task-desc">{{ task.description }}</div>
    </div>
</div>
{% endfor %}
</div>

<div style="margin-top:16px;">
    <label><input type="checkbox" name="with_solutions"> –î–æ–±–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏—è –≤ PDF</label>
</div>

<button id="submitBtn" type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF</button>
</form>

<!-- –ú–û–î–ê–õ -->
<div class="modal-bg" id="modalBg" style="display:none;">
    <div class="modal">
        <div class="modal-close" id="modalClose">‚úñ</div>
        <h2 id="modalTitle"></h2>
        <div><strong>–¢–µ–º–∞:</strong> <span id="modalTopic"></span></div>
        <div><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> <span id="modalLevel"></span></div>
        <div><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span id="modalDesc"></span></div>
        <div><strong>–ó–∞–¥–∞—á–∞:</strong><pre id="modalTask" style="white-space: pre-wrap;"></pre></div>
    </div>
</div>

</main>

<script>
/* –ø—Ä–æ—Å—Ç–æ–π JS: –ø–µ—Ä–µ—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–æ–¥–∞–ª (–∫–æ–ø–∏—è —Ç–≤–æ–µ–≥–æ) */
// const MAX_TIME = {{ MAX_TIME|default:45 }};
const checkboxes = document.querySelectorAll(".task-checkbox");
const timePanel = document.getElementById("timeTotal");
const submitBtn = document.getElementById("submitBtn");
const timePanelBox = document.getElementById("timePanel");

function recalcTime(){
    let sum = 0;
    document.querySelectorAll(".task-item").forEach(item => {
        const cb = item.querySelector(".task-checkbox");
        if(cb && cb.checked){
            sum += parseInt(item.dataset.time);
        }
    });
    timePanel.textContent = sum;
    if(sum > MAX_TIME){
        timePanelBox.classList.add("time-over");
        submitBtn.disabled = true;
    } else {
        timePanelBox.classList.remove("time-over");
        submitBtn.disabled = false;
    }
}

checkboxes.forEach(cb => cb.addEventListener("change", recalcTime));

/* –ú–æ–¥–∞–ª */
const modalBg = document.getElementById("modalBg");
const modalClose = document.getElementById("modalClose");
const mTitle = document.getElementById("modalTitle");
const mTopic = document.getElementById("modalTopic");
const mLevel = document.getElementById("modalLevel");
const mDesc = document.getElementById("modalDesc");
const mTask = document.getElementById("modalTask");

document.querySelectorAll(".preview-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
        e.stopPropagation();
        mTitle.textContent = "–ó–∞–¥–∞—á–∞ ‚Ññ" + btn.dataset.id;
        mTopic.textContent = btn.dataset.topic;
        mLevel.textContent = btn.dataset.level;
        mDesc.textContent = btn.dataset.desc;
        mTask.textContent = btn.dataset.task;
        modalBg.style.display = "flex";
    });
});

modalClose.addEventListener("click", () => modalBg.style.display = "none");
modalBg.addEventListener("click", (e) => { if(e.target === modalBg) modalBg.style.display = "none"; });

</script>

</body>
</html>
