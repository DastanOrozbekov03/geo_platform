{% extends "base.html" %}
{% load static %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<main class="container py-4">

<h1 class="mb-3 fw-bold text-primary">–í—ã–±–æ—Ä –∑–∞–¥–∞—á</h1>

<div id="timePanel" class="time-panel mb-3">
    –ò—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:
    <strong><span id="timeTotal">0</span></strong> –º–∏–Ω –∏–∑ {{ MAX_TIME|default:45 }}
</div>

<form method="post" action="{% url 'generator:generate_pdf' %}">
{% csrf_token %}

{% for task in tasks %}
<div class="border rounded p-3 mb-2 task-item" data-time="{{ task.time_minutes }}">

    <div class="d-flex justify-content-between align-items-center">
        <label class="fw-semibold">
            <input type="checkbox"
                   class="task-checkbox"
                   name="selected_tasks"
                   value="{{ task.id }}">
            ‚Ññ{{ task.id }} ‚Äî {{ task.topic }}
        </label>

        <!-- –ö–ù–û–ü–ö–ê –ì–õ–ê–ó–ê -->
        <button type="button"
                class="btn btn-sm btn-outline-secondary preview-toggle"
                data-target="preview-{{ task.id }}"
                title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–¥–∞—á—É">
            üëÅ
        </button>
    </div>

    <div class="text-muted small mt-1">
        –£—Ä–æ–≤–µ–Ω—å: {{ task.level }} ¬∑ {{ task.time_minutes }} –º–∏–Ω
    </div>

    <!-- PREVIEW -->
    <div id="preview-{{ task.id }}" class="task-preview mt-3 d-none">
        <div class="card card-body bg-light preview-card p-3 shadow-sm rounded">

            <div class="mb-2">
                <strong>–¢–µ–º–∞:</strong> {{ task.topic }}
            </div>

            {% if task.description %}
            <div class="mb-2">
                <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong><br>
                {{ task.description }}
            </div>
            {% endif %}

            <div class="preview-task-text">
                <strong>–ó–∞–¥–∞—á–∞:</strong><br>
                {{ task.task }}
               
                <br>
                <span style="
                    color: #dc3545;
                    font-weight: bold;
                    font-style: italic;
                    background-color: #fff0f0;
                    padding: 2px 4px;
                    border-radius: 3px;
                    font-size: 0.9em;
                ">
                    ‚ö†Ô∏è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—É–¥—É—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
                </span>
                
            </div>

        </div>
    </div>

</div>
{% endfor %}

<div class="mb-3">
    <label for="num_students" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤:</label>
    <input type="number" id="num_students" name="num_students" class="form-control"
            value="1" min="1" max="100" required>
</div>

<button id="submitBtn" class="btn btn-primary mt-3">
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF
</button>

</form>
</main>
{% endblock %}

{% block scripts %}
<script>
const MAX_TIME = {{ MAX_TIME|default:45 }};
const timeTotal = document.getElementById("timeTotal");
const submitBtn = document.getElementById("submitBtn");
const timePanel = document.getElementById("timePanel");

function recalc(){
    let sum = 0;
    document.querySelectorAll(".task-item").forEach(item => {
        if(item.querySelector("input").checked){
            sum += parseInt(item.dataset.time);
        }
    });

    timeTotal.textContent = sum;

    if(sum > MAX_TIME){
        submitBtn.disabled = true;
        timePanel.classList.add("time-over");
    } else {
        submitBtn.disabled = false;
        timePanel.classList.remove("time-over");
    }
}

document.querySelectorAll(".task-checkbox")
    .forEach(cb => cb.addEventListener("change", recalc));

recalc();

// preview toggle
document.querySelectorAll(".preview-toggle").forEach(btn => {
    btn.addEventListener("click", () => {
        const id = btn.dataset.target;
        const preview = document.getElementById(id);

        if (preview.classList.contains("d-none")) {
            preview.classList.remove("d-none");
            btn.textContent = "üôà";
        } else {
            preview.classList.add("d-none");
            btn.textContent = "üëÅ";
        }
    });
});
</script>
{% endblock %}
